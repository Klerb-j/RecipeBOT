#-------------------------------------------------------------------------#
import re
import threading
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters
from services import ai_search, save_user_search, image_search, show_history
from config import BOT_TOKEN
import requests
#-------------------------------------------------------------------------#

#\/------------- –ü–æ–∏—Å–∫ –†–µ—Ü–µ–ø—Ç–∞ -------------\/#
def recipe_search(update, context):
    """
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /search <–∑–∞–ø—Ä–æ—Å> <–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: int> —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏ –æ—Ç –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–µ–ª–µ–≥—Ä–∞–º,
    –î–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –ò–ò –ø–æ —à–∞–±–ª–æ–Ω—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç recipes –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ search_for_food()

    :param update: –¢–µ–ª–µ–≥—Ä–∞–º –ê–ø–¥–µ–π—Ç–µ—Ä, –Ω—É–∂–µ–Ω –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    :param context: –¢–µ–ª–µ–≥—Ä–∞–º –ö–æ–Ω—Ç–µ–∫—Å—Ç, –Ω—É–∂–µ–Ω –¥–ª—è –æ—Å–æ–±—ã—Ö –∫–æ–º–º–∞–Ω–¥, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø—Ä–∏–Ω—è—Ç –ª—é–±—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –ø–æ—Å–ª–µ —Å–∞–º–æ–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã.
    :return: recipes: List[str]
         –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None, –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏—Å—Å–∫—É—Å—Ç–≤–µ–Ω–Ω–æ–π –æ—à–∏–±–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –≤ search_for_food()
    """

    # message - —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è /search <–∑–∞–ø—Ä–æ—Å> <–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ>, .strip —É–±–∏—Ä–∞–µ—Ç –≤—Å–µ –ø—Ä–æ–±–µ–ª—ã –≤ –∫–æ–Ω—Ü–µ –∏ –Ω–∞—á–∞–ª–µ.
    message = update.message.text.strip()
    without_command = message[len("/search "):]

    if " " not in without_command:
        update.message.reply_text("–ù—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ!")
        return None

    # –û—Ç–¥–µ–ª—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞—Ä–≥—É–º–µ–Ω—Ç, –ø—Ä–µ–¥–ø–æ–ª–æ–≥–∞—è —á—Ç–æ —ç—Ç–æ —á–∏—Å–ª–æ
    query, count = without_command.rsplit(" ", 1)
    try:
        amount = int(count)
    except ValueError:
        update.message.reply_text("<–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ> –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º!")
        return None

    update.message.reply_text(f"–ò—â–µ–º '{query}' –≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ {count} —à—Ç—É–∫...")

    # –ü—Ä–æ—Å—Ç–æ–π –¢–∞–π–º–µ—Ä –Ω–∞ 8 —Å–µ–∫—É–Ω–¥
    timer = threading.Timer(8, lambda: update.message.reply_text(
        "üïê –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –ø–æ–∏—Å–∫ –∑–∞–Ω–∏–º–µ—Ç —á—É—Ç—å –¥–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, —á–µ–º –æ–∂–∏–¥–∞–ª–æ—Å—å..."
    ))
    timer.start()

    # –ó–∞–ø—Ä–æ—Å –¥–ª—è –ò–ò, –ù–ï –ú–ï–ù–Ø–¢–¨ –∏–Ω–∞—á–µ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–µ —Å–º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã –∏ –∏—Ö –ù–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π!
    ai_query = f"–ú–æ–∂–µ—à—å –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –Ω–∞–π—Ç–∏ –¢–æ–ø {count} —Ä–µ—Ü–µ–ø—Ç–æ–≤ '{query}', –∏ –ø–∏—Å–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã –≤–º–µ—Å—Ç–µ —Å —Ç—Ä–µ–±—É–µ–º—ã–º–∏ –∏–Ω–≥—Ä–∏–¥–∏–µ–Ω—Ç–∞–º–∏? –í—Å–µ –ù–æ–≤—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã –Ω—É–º–µ—Ä—É–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –Ω–∞—á–∏–Ω–∞—è —Å '1.' '2.' –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ, —á—Ç–æ-–±—ã —è –º–æ–≥ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –∏—Ö –ø–æ –Ω–æ–º–µ—Ä–∞–º, —Ç–∞–∫–∂–µ –ø–æ—Å–ª–µ –Ω—É–º–µ—Ä–∞—Ü–∏–∏ —Å—Ä–∞–∑—É –ø–µ—Ä–µ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º –±–ª—é–¥–∞ –¥–æ–±–∞–≤–ª—è–π –¥–≤–∞ —Ö–µ—à—Ç–µ–≥–∞ (##) –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞–π —Ç–æ—á–∫–æ–π (.), —á—Ç–æ-–±—ã —è –º–æ–≥ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –±–ª—é–¥ –æ—Ç —Å–∞–º–∏—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤.  –ù–∞—á–∏–Ω–∞–π –≤—Å–µ –®–∞–≥–∏ –¥–ª—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è —Å –∑–≤—ë–∑–¥–æ—á–∫–∏ (*) –∏ —Ü–∏—Ñ—Ä—ã (–ü–æ —Ç–∏–ø—É '* 1. –¥–æ–±–∞–≤—å—Ç–µ –º—É–∫–∏.). –¢–∞–∫–∂–µ –ø–æ–ø—Ä–æ—à—É —É–±–∏—Ä–∞—Ç—å –Ω–µ –Ω—É–∂–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–æ—Ç–æ—Ä—ã–π –Ω–∏–∫–∞–∫ –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –†–µ—Ü–µ–ø—Ç—É. –°–ø–∞—Å–∏–±–æ!"

    ai_response = ai_search(ai_query)

    if not ai_response:
        update.message.reply_text("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç.")
        return None

    # –†–∞–∑–¥–µ–ª—è–µ—Ç –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ò–ò –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É: –†–∞–∑—Ä—ã–≤ —Å—Ç—Ä–æ–∫–∏ \n -> —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —á–∏—Å–ª–∞ -> –∏—â–µ—Ç —Ç–æ—á–∫—É –ø–æ—Å–ª–µ —á–∏—Å–ª–∞.
    recipes = re.split(r"\n(?=\d+\.\s)", ai_response.strip())
    timer.cancel()
    return recipes
#/\------------- –ü–æ–∏—Å–∫ –†–µ—Ü–µ–ø—Ç–∞ -------------/\#



#\/------------- –ö–æ–º–∞–Ω–¥—ã –ë–æ—Ç–∞ --------------\/#

def start(update, context):
    update.message.reply_text(
        "‚ùó–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –Ø, –ë–æ—Ç –∫–æ—Ç–æ—Ä—ã–π –∏—â–µ—Ç –†–µ—Ü–µ–ø—Ç—ã –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥.‚ùó"
    )

def help_command(update, context):
        update.message.reply_text(
            """
-------------------------------------------------------------------------------------------
                                           ‚ùó–ü—Ä–∏–≤–µ—Ç!‚ùó

üçô –≠—Ç–æ—Ç –±–æ—Ç –∏—â–µ—Ç —Å–∞–º—ã–µ –ª—É—á—à–∏–µ —Ä–µ—Ü–µ–ø—Ç—ã –ø–æ –≤—Å–µ–π –ó–µ–º–ª–µ! üåØ

üèÅ /start - —á—Ç–æ-–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—â–µ —Ä–∞–∑! üèÅ

‚ùì /help - —á—Ç–æ-–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –∫–æ–º–∞–Ω–¥—ã –ë–æ—Ç–∞! ‚ùì

üîç /search <–∑–∞–ø—Ä–æ—Å> <–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ> - –ü–æ–∏—Å–∫ —Ä–µ—Ü–µ–ø—Ç–æ–≤, 
   <–∑–∞–ø—Ä–æ—Å> - —á—Ç–æ –≤—ã –±—ã —Ö–æ—Ç–µ–ª–∏ –∏—Å–∫–∞—Ç—å, 
   <–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ> - —Å–∫–æ–ª—å–∫–æ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –≤—ã –±—ã —Ö–æ—Ç–µ–ª–∏ –Ω–∞–π—Ç–∏. üîé
    –í–ê–ñ–ù–û! –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ü–∏—Ñ—Ä–æ–π, —Ç–∞–∫-–∂–µ –º–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç—ã –∏–∑ –∏–Ω–≥—Ä–∏–¥–∏–µ–Ω—Ç–æ–≤ (–ü—Ä–∏–º–µ—Ä: /search —Ä–µ—Ü–µ–ø—Ç—ã –∏–∑ —Å–≤–µ–∫–ª—ã 4)

‚ú® /info - –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ, –∫–∞–∫ –∏–º–µ–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –∫–æ–º—É –ø—Ä–µ–Ω–∞–¥–ª–µ–∂–∏—Ç. ‚ú®  

üìñ /history (—Å—Ç–∞—Ä—ã–µ/–Ω–æ–≤—ã–µ)- –í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤, —Ç–∞–∫–∂–µ –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∫–∞–∫ –Ω–∞—á–∏–Ω–∞—Ç—å –æ—Ç—Å—á–µ—Ç, 
   <—Å—Ç–∞—Ä—ã–µ> - —Å —Å–∞–º–æ–≥–æ –¥–∞–≤–Ω–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞, <–Ω–æ–≤—ã–µ> - –¥–æ —Å–∞–º–æ–≥–æ –Ω–æ–≤–æ–≥–æ! 
   ‚ö†Ô∏è –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, —Ç–æ –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç —Å—á–∏—Ç—ã–≤–∞—Ç—å —Å —Å–∞–º–æ–≥–æ –Ω–æ–≤–æ–≥–æ. ‚ö†Ô∏è

‚ö†Ô∏è –û—Å—Ç–æ—Ä–æ–∂–Ω–æ, –ë–æ—Ç –º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ –Ω–µ —Ç–æ —á—Ç–æ –≤—ã —Ö–æ—Ç–µ–ª–∏, –∏–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ –Ω–∞–π—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ—ë —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –û–ø–µ—á–∞—Ç–∫–∏, –ø—Ä–µ–∂–¥–µ —á–µ–º –∏—Å–∫–∞—Ç—å! ‚ö†Ô∏è

-------------------------------------------------------------------------------------------"""
        )

def info(update, context):
    update.message.reply_text(
        """
</\><\/></\><\/></\><\/></\><\/></\><\/></\><\/></\><\/></\><\/></\><\/>
                          ‚ùì –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ‚ùì
–ë–æ—Ç –†–µ—Ü–µ–ø—Ç–æ–≤ –∏–º–µ–Ω–∏ –ß–µ—Ä—á–∏–ª–ª—è III(???) - –æ–±—â–µ–¥–æ—Å—Ç—É–ø–Ω—ã–π –¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç, –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–π –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –ò—Ç–∞–ª–∏–∏ –∑–∞ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ì–∞–≤–∞–π—Å–∫–æ–π –ü–∏—Ü—Ü—ã. 

–î–∞–Ω–Ω—ã–π –ë–æ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥–æ–º—É –±–µ—Å–ø–ª–∞—Ç–Ω–æ. –î–ª—è –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö —Ü–µ–ª–µ–π –Ω—É–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å –ê–≤—Ç–æ—Ä—É –∏–Ω—Å—Ç–∏—Ç—É—Ç –≤–º–µ—Å—Ç–µ —Å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ–º –∏ –ø–∏—Ç–∞–Ω–∏–µ–º, –∞ —Ç–∞–∫–∂–µ —Å –ø–æ—Å–ª–µ–¥—É—é—â–∏–º–∏ —Ç—Ä–∞—Ç–∞–º–∏ –Ω–∞ –ú–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä—É –∏ –î–æ–∫—Ç–æ—Ä–∞–Ω—Ç—É—Ä—É!
                         ‚ùî –û —Ä–∞–±–æ—Ç–µ –ë–æ—Ç–∞ ‚ùî
–ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –∫–æ–º–∞–Ω–¥—É /info –∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–µ—á–µ–Ω–∏–∏ 10 –ª–µ—Ç, –∑–Ω–∞—á–∏—Ç –±–æ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–∏—Å–ª–∞—Ç—å –ê–≤—Ç–æ—Ä—É –æ—Ç—á—ë—Ç –æ–± –æ—à–∏–±–∫–µ –ø–æ –≥–æ–ª—É–±–∏–Ω–Ω–æ–π –ø–æ—á—Ç–µ, –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ - —Ä–∞–±–æ—Ç–∞–µ—Ç.

–û —Ä–∞–±–æ—Ç–µ /search: –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –æ—Ç –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¢–µ–ª–µ–≥—Ä–∞–º, —Ä–∞–∑–Ω–∏–º–∞–µ—Ç <–∑–∞–ø—Ä–æ—Å> –æ—Ç <–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ>, –∑–∞—Ç–µ–º –ø–µ—Ä–µ–¥–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –ò–ò –¥–ª—è –ø–æ–∏—Å–∫–∞ –ª—É—á—à–∏—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤, –¥–∞–ª–µ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Ä–∞–∑–¥–µ–ª—è–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ –æ—Ç —Ä–µ—Ü–µ–ø—Ç–∞, —á—Ç–æ-–±—ã –ø–µ—Ä–µ–¥–∞—Ç—å –µ–≥–æ –≤ –ø–æ–∏—Å–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ—Ç Unsplash.

–æ —Ä–∞–±–æ—Ç–µ /history: –ü—Ä–æ–≥—Ä–∞–º–º–∞ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ –î–∞—Ç–∞–±–∞–∑–µ (SupaBase) –Ω–∞ –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID –∏ –∏–º–µ–Ω–∏, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ —ç—Ç–æ–≥–æ –∏—Å–∫–∞–ª —á—Ç–æ-–ª–∏–±–æ, —Ç–æ –≤—ã–≤–æ–¥–∏—Ç –∏—Å—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –Ω–µ—Ç - —Ç–æ –Ω–µ—Ç.

</\><\/></\><\/></\><\/></\><\/></\><\/></\><\/></\><\/></\><\/></\><\/>
    """)



def search_for_food(update, context):
    """
    –ù–∞—á–∏–Ω–∞–µ—Ç —Å –≤—ã–∑–æ–≤–∞ –∏ —Å–±–æ—Ä–∞ —Ñ—É–Ω–∫—Ü–∏–∏ recipe_search(), –µ—Å–ª–∏ –≤—ã–¥–∞–Ω None, –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É, —Å–æ–∑–¥–∞–≤–∞—è –±–µ–∑–≤—Ä–µ–¥–Ω—É—é –æ—à–∏–±–∫—É,
    –¥–∞–ª–µ–µ —Å –ø–æ–º–æ—â—å—é —Ü–∏–∫–ª–∞ —Ä–∞–∑–¥–µ–ª—è–µ—Ç —Ä–µ—Ü–µ–ø—Ç—ã –∏ —Ç–∞–∫–∂–µ –Ω–∞—Ö–æ–¥–∏—Ç –∏—Ö –Ω–∞–∑–≤–∞–Ω–∏—è, –ø–µ—Ä–µ–¥–∞–≤–∞—è –∏—Ö –≤ –ø–æ–∏—Å–∫–æ–≤–∏–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π services.py -> image_search(–∑–∞–ø—Ä–æ—Å)

    :param update: –¢–µ–ª–µ–≥—Ä–∞–º –ê–ø–¥–µ–π—Ç–µ—Ä, –Ω—É–∂–µ–Ω –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    :param context: –¢–µ–ª–µ–≥—Ä–∞–º –ö–æ–Ω—Ç–µ–∫—Å—Ç, –Ω—É–∂–µ–Ω –¥–ª—è –æ—Å–æ–±—ã—Ö –∫–æ–º–º–∞–Ω–¥, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø—Ä–∏–Ω—è—Ç –ª—é–±—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –ø–æ—Å–ª–µ —Å–∞–º–æ–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã.
    """

    results = recipe_search(update, context)
    if not results:
        return

    for recipe in results:
        user = update.message.from_user
        recipe = recipe.strip()
        update.message.reply_text(recipe)

        # –æ—Ç–¥–µ–ª—è–µ—Ç —Ä–µ—Ü–µ–ø—Ç—ã –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É: –Ω–∞—á–∞–ª–æ —Å—Ç—Ä–æ–∫–∏ -> –ª—é–±–∞—è —Ü–∏—Ñ—Ä–∞ -> —Ç–æ—á–∫–∞ -> –ª—é–±–æ–π —Ç–µ–∫—Å—Ç -> –µ—â—ë —Ü–∏—Ñ—Ä—ã (–ø–æ–¥-–∫–ª–∞—Å—Å), –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Ç–∞–∫–∂–µ –≤–∫–ª—é—á–µ–Ω –≤ –æ–¥–Ω—É –≥—Ä—É–ø–ø—É -> –µ—â–µ —Ç–µ–∫—Å—Ç.
        clean_recipe = re.sub(r'^(\d+\.)\s+\d+\.\s+', r'\1 ', recipe)
        save_user_search(user.id, user.username, clean_recipe)  # <- —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ò—Å—Ç–æ—Ä–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.

        # –ò—â–µ—Ç –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞ –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É: –¥–≤–∞ —Ö–µ—à—Ç–µ–≥–∞ ## -> –≤—Å–µ, —á—Ç–æ —Å—Ç–æ–∏—Ç –ø–æ—Å–ª–µ –Ω–µ–≥–æ -> –∏—â–µ—Ç —Ç–æ—á–∫—É.
        match = re.search(r"##(.+?)\.", recipe)
        if match:
            title = match.group(1).strip()
            image_url = image_search(title, update)  # <- –ø–æ–∏—Å–∫ –≥—É–≥–ª –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ –ù–∞–∑–≤–∞–Ω–∏—é
            if image_url:
                update.message.reply_photo(image_url)
            else:
                return


def create_bot():
    """
    –°–æ–∑–¥–∞–µ—Ç —Ö—ç–Ω–¥–ª–µ—Ä –¥–ª—è –∫–æ–º–º–∞–Ω–¥, –∞ —Ç–∞–∫–∂–µ dispatcher –∏ updater

    :return: updater: –¢–µ–ª–µ–≥—Ä–∞–º –ê–ø–¥–µ–π—Ç–µ—Ä, –Ω—É–∂–µ–Ω –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    """
    updater = Updater(BOT_TOKEN, use_context=True)

    # –î–∏—Å–ø–∞—Ç—á–µ—Ä, —Ä–∞–∑–±–∏—Ä–∞–µ—Ç —á—Ç–æ –µ—Å—Ç—å –∫–æ–º–∞–Ω–¥–∞, –∞ —á—Ç–æ –Ω–µ—Ç
    dp = updater.dispatcher

    dp.add_handler(CommandHandler("start", start))

    dp.add_handler(CommandHandler("help", help_command))

    dp.add_handler(CommandHandler("info", info))

    dp.add_handler(CommandHandler("search", search_for_food))

    dp.add_handler(CommandHandler("history", show_history))

    dp.add_handler(MessageHandler(Filters.text, lambda update, context: update.message.reply_text(
        "–¢–∞–∫–æ–π –∫–æ–º–∞–Ω–¥—ã –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞ –æ–ø–µ—á–∞—Ç–∫–∏, –ª–∏–±–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /help, –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥!"
    )))

    return updater


#/\------------- –ö–æ–º–∞–Ω–¥—ã –ë–æ—Ç–∞ --------------/\#
